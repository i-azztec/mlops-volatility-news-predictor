apiVersion: 1

groups:
  - name: model_performance_alerts
    folder: "Model Monitoring"
    interval: 30s
    rules:
      - uid: model_auc_alert
        title: "Model AUC Drop Alert"
        condition: B
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 600
              to: 0
            datasource:
              type: postgres
              uid: postgres_ds
            model:
              format: time_series
              rawSql: |
                SELECT 
                  EXTRACT(EPOCH FROM timestamp) * 1000 as time,
                  COALESCE(value, 0) as value
                FROM volatility_metrics 
                WHERE metric_name = 'auc'
                  AND timestamp > NOW() - INTERVAL '10 minutes'
                ORDER BY timestamp
          - refId: B
            queryType: ""
            datasource:
              type: __expr__
              uid: __expr__
            model:
              expression: reduce(A, last()) < 0.52
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
        noDataState: NoData
        execErrState: Alerting
        for: 2m
        annotations:
          description: "Model AUC has dropped below 0.52. Immediate attention required."
          summary: "Model performance degradation detected"
        labels:
          severity: "critical"
          team: "ml-ops"

      - uid: model_f1_alert
        title: "Model F1-Score Drop Alert"  
        condition: B
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 600
              to: 0
            datasource:
              type: postgres
              uid: postgres_ds
            model:
              format: time_series
              rawSql: |
                SELECT 
                  EXTRACT(EPOCH FROM timestamp) * 1000 as time,
                  COALESCE(value, 0) as value
                FROM volatility_metrics 
                WHERE metric_name = 'f1'
                  AND timestamp > NOW() - INTERVAL '10 minutes'
                ORDER BY timestamp
          - refId: B
            queryType: ""
            datasource:
              type: __expr__
              uid: __expr__
            model:
              expression: reduce(A, last()) < 0.6
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
        noDataState: NoData
        execErrState: Alerting
        for: 2m
        annotations:
          description: "Model F1-Score has dropped below 0.6. Model retraining may be needed."
          summary: "Model F1-Score degradation detected"
        labels:
          severity: "warning"
          team: "ml-ops"
